name: Trigger e2e tests against PR

on:
  pull_request:
    types: [labeled, unlabeled]
  issue_comment:
    types: [created]

jobs:
  dispatchedPR:
    name: Dispatch wait and check
    runs-on: ubuntu-latest

    steps:
      - name: Check if label or comment triggers the action
        id: check
        run: |
          echo "should_trigger=false" >> $GITHUB_OUTPUT
          if [[ "${{ github.event.pull_request.labels.*.name }}" == *"e2e-tests"* ]]; then
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ github.event.comment.body }}" == "e2e-tests" ]]; then
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          fi
      - name: Trigger E2E Tests
        if: steps.check.outputs.should_trigger == 'true'
        run: |
          gh workflow run -R Graylog2/e2e-tests run-e2e-tests.yml --ref main
            -f caller_repo=${{ github.repository }} \
            -f caller_pr_nr=${{ github.event.pull_request.number }} \
            -f caller_base_branch=${{ github.event.pull_request.base.ref }} \
            -f caller_head_branch=${{ github.event.pull_request.head.ref }} \
            -f head_sha=${{ github.event.pull_request.head.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_E2E_TESTS_WORKFLOW_RW }}

