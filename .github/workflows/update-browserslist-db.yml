name: Update browserslist DB.

on: 
  schedule:
    - cron: '0 0 1/14 * MON-FRI'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest 
    defaults:
      run:
        working-directory: graylog2-web-interface

    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: yarn install
      - name: Updating browserslist db
        continue-on-error: true
        run: npx browserslist@latest --update-db
      - name: Create/Update Pull Request
        id: pr-create
        uses: Graylog2/create-pull-request@7380612b49221684fefa025244f2ef4008ae50ad
        with:
          title: Updating browserslist DB.
          body: This PR was created by a job that is running periodically to update the browserslist db automatically. See [here](https://github.com/browserslist/browserslist#browsers-data-updating) for details.
          author: Dr. Lint-a-lot <garybot2@graylog.com>
          branch: update/browserslist-db
          committer: Dr. Lint-a-lot <garybot2@graylog.com>
          commit-message: Updating browserslist DB.
          delete-branch: true

      - name: Get head SHA of PR
        id: pr-head-sha
        if: ${{ steps.pr-create.outputs.pull-request-operation != "closed" }}
        run: >
          git fetch &&
          echo "sha=$(git rev-parse origin/$(gh pr view ${{ steps.pr-create.outputs.pull-request-number }} --json headRefName --template '{{.headRefName}}'))" >> $GITHUB_OUTPUT

      - name: Request dispatched PR build
        if: ${{ steps.pr-create.outputs.pull-request-operation != "closed" }}
        run: >
          gh workflow run -R Graylog2/graylog-project-internal pr-build.yml --ref master
          -f caller_repo=${{ github.repository }}
          -f caller_pr_nr=${{ steps.pr-create.outputs.pull-request-number }}
          -f caller_base_branch=${{ github.base_ref || github.ref_name }}
          -f caller_head_branch=${{ github.head_ref }}
          -f head_sha=${{ steps.pr-head-sha.outputs.sha }}
          -f initial_actor="Dr. Lint-a-lot"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GRAYLOG_PROJECT_INTERNAL_WORKFLOW_RW }}
